---
# tasks file for nix (install Nix and direnv) â€” macOS only via Homebrew

- name: Skip if role already executed
  meta: end_role
  when: vars[role_execution_flag] | default(false)

- name: Determine allowed platform for Nix setup (macOS MacBook only)
  set_fact:
    nix_macos_allowed: >-
      {{ (ansible_facts['os_family'] | default('')) == 'Darwin' and (device_type | default('')) == 'macbook' }}

- name: Stop role when not on a supported platform (macOS MacBook)
  meta: end_role
  when: not (nix_macos_allowed | bool)

- block:
    - name: Ensure direnv is installed via Homebrew (nix must be installed manually) (macOS)
      community.general.homebrew:
        name:
          - direnv
        state: present
      become: false

  when: nix_macos_allowed | bool

- name: Ensure Nix shell guard block is at top of ~/.zprofile
  ansible.builtin.blockinfile:
    path: "{{ ansible_env.HOME }}/.zprofile"
    create: true
    insertbefore: BOF
    block: |
      if [[ -z "$IN_NIX_SHELL" ]]; then
          [[ -x /opt/homebrew/bin/brew ]] && eval "$(/opt/homebrew/bin/brew shellenv)"
          [[ -d "$HOME/Library/Application Support/JetBrains/Toolbox/scripts" ]] && \
              export PATH="$PATH:$HOME/Library/Application Support/JetBrains/Toolbox/scripts"
      fi
  when: nix_macos_allowed | bool
  become: false

- name: Mark role as executed
  set_fact:
    "{{ role_execution_flag }}": true
    cacheable: true
