---
# tasks file for ukelele (install Ukelele via Homebrew Cask on macOS)

- name: Skip if role already executed
  meta: end_role
  when: vars[role_execution_flag] | default(false)

- name: Determine allowed platform for Ukelele setup (macOS MacBook only)
  set_fact:
    ukelele_macos_allowed: >-
      {{ (ansible_facts['os_family'] | default('')) == 'Darwin' and (device_type | default('')) == 'macbook' }}

- name: Stop role when not on a supported platform (macOS MacBook)
  meta: end_role
  when: not (ukelele_macos_allowed | bool)

- block:
    - name: Ensure Ukelele is present via Homebrew Cask (macOS)
      community.general.homebrew_cask:
        name: ukelele
        state: present
      become: false

    - name: Define Keyboard Layout target directory (under user's Library)
      set_fact:
        keyboard_layout_dir: "{{ ansible_env.HOME }}/Library/Keyboard Layout"

    - name: Ensure 'Keyboard Layout' directory exists in user's Library
      ansible.builtin.file:
        path: "{{ keyboard_layout_dir }}"
        state: directory
        mode: '0755'
      become: false

    - name: Check if 'French - Custom.bundle' already exists in Keyboard Layout
      ansible.builtin.stat:
        path: "{{ keyboard_layout_dir }}/French - Custom.bundle"
      register: french_custom_bundle_stat

    - name: Copy 'French - Custom.bundle' into Keyboard Layout if missing
      ansible.builtin.copy:
        src: "French - Custom.bundle"
        dest: "{{ keyboard_layout_dir }}/French - Custom.bundle"
        mode: preserve
      when: not (french_custom_bundle_stat.stat.exists | default(false))
      become: false

  when: ukelele_macos_allowed | bool

- name: Mark role as executed
  set_fact:
    "{{ role_execution_flag }}": true
    cacheable: true
