---
# tasks file for neovim (install via Homebrew on macOS or pacman on Arch Linux)

- name: Skip if role already executed
  meta: end_role
  when: vars[role_execution_flag] | default(false)

- name: Determine allowed platforms for Neovim setup (macOS MacBook or Arch Linux)
  set_fact:
    neovim_macos_allowed: >-
      {{ (ansible_facts['os_family'] | default('')) == 'Darwin' and (device_type | default('')) == 'macbook' }}
    neovim_arch_allowed: >-
      {{ (ansible_facts['os_family'] | default('')) == 'Archlinux' or
         (ansible_facts['distribution'] | default('')) == 'Archlinux' or
         (distro | default('')) == 'archlinux' }}

- name: Stop role when not on a supported platform (macOS MacBook or Arch Linux)
  meta: end_role
  when: not (neovim_macos_allowed | bool or neovim_arch_allowed | bool)

- block:
    - name: Ensure Neovim is installed via Homebrew (macOS)
      community.general.homebrew:
        name: neovim
        state: present
      become: false

    - name: Define dotfiles paths
      set_fact:
        dotfiles_dir: "{{ (dotfiles_dir | default(ansible_env.HOME + '/Desktop/workspace/projects/dotfiles')) }}"
        user_home_dir: "/Users/{{ target_user }}"
        target_group: staff

    - name: Check if nvim config folder exists
      stat:
        path: "{{ user_home_dir }}/.config/nvim"
      register: nvim_config_folder_stat

    - name: Backup existing Neovim config folder if it exists
      command: mv "{{ user_home_dir }}/.config/nvim" "{{ dotfiles_dir }}/nvim_backup"
      when: nvim_config_folder_stat.stat.exists and (sym.stat.islnk is defined and sym.stat.islnk == False)

    - name: Create symlink to Neovim config folder
      file:
        src: "{{ dotfiles_dir }}/neovim"
        dest: "{{ user_home_dir }}/.config/nvim"
        state: link

  when: neovim_macos_allowed | bool

- block:
    - name: Ensure Neovim is installed via pacman (Arch Linux)
      community.general.pacman:
        name: neovim
        state: present
      become: true
  when: neovim_arch_allowed | bool

- name: Mark role as executed
  set_fact:
    "{{ role_execution_flag }}": true
    cacheable: true
