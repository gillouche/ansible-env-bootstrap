---
# tasks file for java (install OpenJDK, Maven, Gradle) â€” macOS only

- name: Skip if role already executed
  meta: end_role
  when: vars[role_execution_flag] | default(false)

- name: Determine allowed platform for Java setup (macOS MacBook only)
  set_fact:
    java_macos_allowed: >-
      {{ (ansible_facts['os_family'] | default('')) == 'Darwin' and (device_type | default('')) == 'macbook' }}

- name: Stop role when not on a supported platform (macOS MacBook)
  meta: end_role
  when: not (java_macos_allowed | bool)

- block:
    - name: Ensure OpenJDK (default and 21), Maven, Gradle, and jenv are installed via Homebrew (macOS)
      community.general.homebrew:
        name:
          - openjdk
          - openjdk@21
          - maven
          - gradle
          - jenv
        state: latest
      become: false

    - name: Ensure jenv init is configured in ~/.zshrc (macOS)
      ansible.builtin.blockinfile:
        path: "{{ ansible_env.HOME }}/.zshrc"
        create: true
        marker: "# {mark} ANSIBLE MANAGED BLOCK: jenv (macOS)"
        block: |
          # jenv (managed by Ansible)
          export PATH="$HOME/.jenv/bin:$PATH"
          eval "$(jenv init -)"
      when: java_macos_allowed | bool
      become: false

    - name: Detect Homebrew prefix (Apple Silicon vs Intel) for JDK paths
      set_fact:
        brew_prefix: >-
          {{ '/opt/homebrew' if (ansible_facts['architecture'] | default('')).startswith('arm') else '/usr/local' }}

    - name: Stat OpenJDK bundle paths (default and 21)
      ansible.builtin.stat:
        path: "{{ item }}"
      register: jdk_bundles
      loop:
        - "{{ brew_prefix }}/opt/openjdk/libexec/openjdk.jdk"
        - "{{ brew_prefix }}/opt/openjdk@21/libexec/openjdk.jdk"

    - name: Ensure /Library/Java/JavaVirtualMachines symlinks exist for Homebrew JDKs (requires sudo)
      ansible.builtin.file:
        src: "{{ item.item }}"
        dest: "{{ '/Library/Java/JavaVirtualMachines/' + (item.item.split('/')[-3] | regex_replace('@', '-') ) + '.jdk' }}"
        state: link
        force: true
      loop: "{{ jdk_bundles.results }}"
      when:
        - java_create_system_jdk_symlinks | default(false) | bool
        - item.stat.exists | default(false)
      become: true

    - name: Locate jenv binary (macOS)
      ansible.builtin.command: >-
        bash -lc 'export PATH="/opt/homebrew/bin:/usr/local/bin:$PATH"; command -v jenv'
      register: jenv_cmd
      changed_when: false
      failed_when: jenv_cmd.rc != 0

    - name: Add detected JDKs to jenv (idempotent)
      ansible.builtin.command: >-
        bash -lc '"${JENV_BIN}" add "${JDK_HOME}"'
      environment:
        JENV_BIN: "{{ jenv_cmd.stdout | trim }}"
        JDK_HOME: "{{ item.item }}/Contents/Home"
      loop: "{{ jdk_bundles.results }}"
      when: item.stat.exists | default(false)
      changed_when: false
      failed_when: false
      become: false

    - name: Ensure JAVA_HOME and PATH are configured in ~/.zshrc (macOS)
      ansible.builtin.blockinfile:
        path: "{{ ansible_env.HOME }}/.zshrc"
        create: true
        marker: "# {mark} ANSIBLE MANAGED BLOCK: java (macOS)"
        block: |
          # Java environment (managed by Ansible)
          # Prefer system helper to detect the current Java Home
          export JAVA_HOME="$({ /usr/libexec/java_home; } 2>/dev/null)"
          [[ -n "$JAVA_HOME" ]] && export PATH="$JAVA_HOME/bin:$PATH"
          # Also include Homebrew OpenJDK shims if present (Apple Silicon / Intel)
          [[ -d /opt/homebrew/opt/openjdk/bin ]] && export PATH="/opt/homebrew/opt/openjdk/bin:$PATH"
          [[ -d /usr/local/opt/openjdk/bin ]] && export PATH="/usr/local/opt/openjdk/bin:$PATH"
          # Include OpenJDK 21 shims as well if installed
          [[ -d /opt/homebrew/opt/openjdk@21/bin ]] && export PATH="/opt/homebrew/opt/openjdk@21/bin:$PATH"
          [[ -d /usr/local/opt/openjdk@21/bin ]] && export PATH="/usr/local/opt/openjdk@21/bin:$PATH"
      when: java_macos_allowed | bool
      become: false
  when: java_macos_allowed | bool

- name: Mark role as executed
  set_fact:
    "{{ role_execution_flag }}": true
    cacheable: true
