---
# tasks file for python (pyenv + install specified versions)

- name: Skip if role already executed
  meta: end_role
  when: vars[role_execution_flag] | default(false)

- name: Determine allowed platforms for python setup (macOS MacBook or Arch Linux)
  set_fact:
    python_macos_allowed: >-
      {{ (ansible_facts['os_family'] | default('')) == 'Darwin' and (device_type | default('')) == 'macbook' }}
    python_arch_allowed: >-
      {{ (ansible_facts['os_family'] | default('')) == 'Archlinux' or
         (ansible_facts['distribution'] | default('')) == 'Archlinux' or
         (distro | default('')) == 'archlinux' }}

- name: Stop role when not on a supported platform (macOS MacBook or Arch Linux)
  meta: end_role
  when: not (python_macos_allowed | bool or python_arch_allowed | bool)

- block:
    - name: Ensure pyenv is installed via Homebrew (macOS)
      community.general.homebrew:
        name:
          - pyenv
          - uv
        state: present
      become: false

    - name: Ensure pyenv build dependencies are present (macOS)
      community.general.homebrew:
        name: "{{ python_pyenv_brew_dependencies | default([]) }}"
        state: present
      when: (python_pyenv_brew_dependencies | default([])) | length > 0
      become: false

    - name: Locate pyenv binary (macOS)
      ansible.builtin.command: >-
        bash -lc 'export PATH="/opt/homebrew/bin:/usr/local/bin:$PATH"; command -v pyenv'
      register: pyenv_cmd
      changed_when: false
      failed_when: pyenv_cmd.rc != 0

    - name: Install requested Python versions via pyenv (macOS)
      ansible.builtin.command: >-
        bash -lc 'export PATH="/opt/homebrew/bin:/usr/local/bin:$PATH"; "${PYENV_BIN}" install -s "${PY_VER}"'
      environment:
        PYENV_BIN: "{{ pyenv_cmd.stdout | trim }}"
        PY_VER: "{{ item }}"
      loop: "{{ python_versions | default([]) }}"
      loop_control:
        label: "{{ item }}"
      changed_when: false
      become: false
  when: python_macos_allowed | bool

- block:
    - name: Ensure pyenv is installed (Arch) using pacman module
      community.general.pacman:
        name:
          - pyenv
          - uv
        state: present
      become: true

    - name: Locate pyenv binary (Arch)
      ansible.builtin.command: bash -lc 'command -v pyenv'
      register: pyenv_cmd
      changed_when: false
      failed_when: pyenv_cmd.rc != 0

    - name: Install requested Python versions via pyenv (Arch)
      ansible.builtin.command: >-
        bash -lc '"${PYENV_BIN}" install -s "${PY_VER}"'
      environment:
        PYENV_BIN: "{{ pyenv_cmd.stdout | trim }}"
        PY_VER: "{{ item }}"
      loop: "{{ python_versions | default([]) }}"
      loop_control:
        label: "{{ item }}"
      changed_when: false
      become: false
  when: python_arch_allowed | bool

- name: Ensure pyenv init is configured in ~/.zshrc (idempotent)
  ansible.builtin.blockinfile:
    path: "{{ ansible_env.HOME }}/.zshrc"
    create: true
    marker: "# {mark} ANSIBLE MANAGED BLOCK: pyenv initialization"
    block: |
      export PYENV_ROOT="$HOME/.pyenv"
      [[ -d $PYENV_ROOT/bin ]] && export PATH="$PYENV_ROOT/bin:$PATH"
      eval "$(pyenv init - zsh)"
  when: (python_macos_allowed | bool) or (python_arch_allowed | bool)
  become: false

- name: Mark role as executed
  set_fact:
    "{{ role_execution_flag }}": true
    cacheable: true
