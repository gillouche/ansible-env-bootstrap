---
# tasks file for karabiner (install Karabiner-Elements via Homebrew Cask on macOS)

- name: Skip if role already executed
  meta: end_role
  when: vars[role_execution_flag] | default(false)

- name: Determine allowed platform for Karabiner setup (macOS MacBook only)
  set_fact:
    karabiner_macos_allowed: >-
      {{ (ansible_facts['os_family'] | default('')) == 'Darwin' and (device_type | default('')) == 'macbook' }}

- name: Stop role when not on a supported platform (macOS MacBook)
  meta: end_role
  when: not (karabiner_macos_allowed | bool)

- block:
    - name: Ensure Karabiner-Elements is present via Homebrew Cask (macOS)
      community.general.homebrew_cask:
        name: karabiner-elements
        state: present
      become: false

    - name: Create complex_modifications folder
      file:
        path: "{{ ansible_env.HOME }}/.config/karabiner/assets/complex_modifications"
        state: directory
        mode: '0755'
        recurse: yes

    - name: Copy Karabiner rules
      copy:
        src: "files/{{ item }}"
        dest: "{{ ansible_env.HOME }}/.config/karabiner/assets/complex_modifications/{{ item }}"
        mode: '0644'
      loop:
        - french_azerty_brackets.json
        - french_azerty_swap_keys.json

  when: karabiner_macos_allowed | bool

- name: Mark role as executed
  set_fact:
    "{{ role_execution_flag }}": true
    cacheable: true
