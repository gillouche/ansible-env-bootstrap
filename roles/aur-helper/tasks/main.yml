---
# tasks file for aur-helper (validates that an AUR helper like yay is available)

- name: Skip if role already executed
  meta: end_role
  when: vars[role_execution_flag] | default(false)

- name: Determine if role is allowed on this host (Arch Linux only)
  set_fact:
    aur_helper_allowed: >-
      {{ (ansible_facts['os_family'] | default('')) == 'Archlinux' or
         (ansible_facts['distribution'] | default('')) == 'Archlinux' or
         (distro | default('')) == 'archlinux' }}

- name: Stop role when not on Arch Linux
  meta: end_role
  when: not aur_helper_allowed | bool

- block:
    - name: Check if yay is available in PATH
      ansible.builtin.command: bash -lc 'command -v yay'
      register: yay_cmd
      failed_when: false
      changed_when: false

    - name: Set aur_helper_bin if found
      ansible.builtin.set_fact:
        aur_helper_bin: >-
          {{ (yay_cmd.stdout if (yay_cmd.rc == 0) else '') | trim }}

    - name: Fail if yay is not installed
      ansible.builtin.fail:
        msg: >-
          yay not found. Please install one manually before running this playbook.
          See: https://wiki.archlinux.org/title/Arch_User_Repository#Installing_packages
      when: (yay_cmd.rc | default(1)) != 0

  when: aur_helper_allowed | bool

- name: Mark role as executed
  set_fact:
    "{{ role_execution_flag }}": true
    cacheable: true
